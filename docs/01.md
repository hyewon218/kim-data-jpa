# í”„ë¡œì íŠ¸ í™˜ê²½ì„¤ì •
## ğŸ“Spring Data JPA
- ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•˜ë©´ ê¸°ì¡´ì˜ í•œê³„ë¥¼ ë„˜ì–´ì„œ ë§ˆë²•ì²˜ëŸ¼ ë¦¬í¬ì§€í† ë¦¬ì˜ êµ¬í˜„ í´ë˜ìŠ¤ ì—†ì´ ì¸í„°í˜ì´ìŠ¤ë§Œìœ¼ë¡œ ê°œë°œì„ ì™„ë£Œí•  ìˆ˜ ìˆë‹¤.
- ê¸°ë³¸ì ì¸ CRUD ê¸°ëŠ¥ë“¤ë„ ëª¨ë‘ ì œê³µí•œë‹¤.
- ì½”ë“œê°€ ì¤„ì–´ë“¤ì–´ ê°œë°œìëŠ” í•µì‹¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ê°œë°œí•˜ëŠ” ë°ì— ì§‘ì¤‘í•  ìˆ˜ê°€ ìˆë‹¤.
- ì•ì„  ê°•ì˜ì—ì„œëŠ” ì˜ë„ì ìœ¼ë¡œ ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ìŠ¤í”„ë§ê³¼ JPA ìì²´ì— ì´ˆì ì„ ë§ì¶”ì—ˆë‹¤.
- ìŠ¤í”„ë§ ë°ì´í„° JPAëŠ” JPAë¥¼ ì •ë§ í¸ë¦¬í•˜ê²Œ ì‚¬ìš©í•˜ë„ë¡ ë„ì™€ì£¼ëŠ” ê¸°ìˆ ì´ë‹¤.
- But, JPAì— ë„ˆë¬´ ë§ì€ ë¶€ë¶„ì„ ìë™í™”í•˜ê³  ì¶”ìƒí™”ë¥¼ í•´ë²„ë¦¼
- ê·¸ëŸ¬ë‹ˆê¹Œ JPAì— ëŒ€í•œ ê¸°ë³¸ ì´í•´ ì—†ì´ ì²˜ìŒë¶€í„° ìŠ¤í”„ë§ ë°ì´í„° JPAë¥¼ ë°”ë¡œ ì‚¬ìš©í•´ë²„ë¦¬ë©´ ê¹Šì´ ìˆëŠ” ë‚´ë¶€ ë™ì‘ ë°©ì‹ì„ ì´í•´í•˜ê¸° ì–´ë µë‹¤.<br>
ì¥ì• ê°€ ìƒê¸°ê±°ë‚˜ ë¬¸ì œê°€ ìƒê²¼ì„ ë•Œ ê·¼ë³¸ì ì¸ ë¬¸ì œë¥¼ ì°¾ì•„ì•¼ í•´ê²°ì´ ë˜ëŠ”ë° ê·¸ê²ƒì´ ì–´ë ¤ì›Œì§„ë‹¤.

<br>

## Gradle ì „ì²´ ì„¤ì •
```groovy
plugins {
    id 'java'
    id 'org.springframework.boot' version '3.1.4'
    id 'io.spring.dependency-management' version '1.1.3'
}

group = 'study'
version = '0.0.1-SNAPSHOT'

java {
    sourceCompatibility = '17'
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    compileOnly 'org.projectlombok:lombok'
    runtimeOnly 'com.h2database:h2'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

tasks.named('test') {
    useJUnitPlatform()
}
```

## ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚´í´ë³´ê¸°
### gradle ì˜ì¡´ê´€ê³„ ë³´ê¸°
`./gradlew dependencies --configuration compileClasspath`
### ìŠ¤í”„ë§ ë¶€íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚´í´ë³´ê¸°
- spring-boot-starter-web 
  - spring-boot-starter-tomcat: í†°ìº£ (ì›¹ì„œë²„) 
  - spring-webmvc: ìŠ¤í”„ë§ ì›¹ MVC
- spring-boot-starter-data-jpa 
  - spring-boot-starter-aop
  - spring-boot-starter-jdbc
    - HikariCP ì»¤ë„¥ì…˜ í’€ (ë¶€íŠ¸ 2.0 ê¸°ë³¸)
  - hibernate + JPA: í•˜ì´ë²„ë„¤ì´íŠ¸ + JPA
  - spring-data-jpa: ìŠ¤í”„ë§ ë°ì´í„° JPA 
- spring-boot-starter(ê³µí†µ): ìŠ¤í”„ë§ ë¶€íŠ¸ + ìŠ¤í”„ë§ ì½”ì–´ + ë¡œê¹…
  - spring-boot 
    - spring-core
  - spring-boot-starter-logging 
    - logback, slf4j

### í…ŒìŠ¤íŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬
- spring-boot-starter-test
  - junit: í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬, ìŠ¤í”„ë§ ë¶€íŠ¸ 2.2ë¶€í„° junit5( jupiter ) ì‚¬ìš©
    - ê³¼ê±° ë²„ì „ì€ vintage
  - mockito: ëª© ë¼ì´ë¸ŒëŸ¬ë¦¬
  - assertj: í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì¢€ ë” í¸í•˜ê²Œ ì‘ì„±í•˜ê²Œ ë„ì™€ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬
    - https://joel-costigliola.github.io/assertj/index.html
  - spring-test: ìŠ¤í”„ë§ í†µí•© í…ŒìŠ¤íŠ¸ ì§€ì› 
- í•µì‹¬ ë¼ì´ë¸ŒëŸ¬ë¦¬
  - ìŠ¤í”„ë§ MVC 
  - ìŠ¤í”„ë§ ORM 
  - JPA, í•˜ì´ë²„ë„¤ì´íŠ¸ 
  - ìŠ¤í”„ë§ ë°ì´í„° JPA
- ê¸°íƒ€ ë¼ì´ë¸ŒëŸ¬ë¦¬
  - H2 ë°ì´í„°ë² ì´ìŠ¤ í´ë¼ì´ì–¸íŠ¸ 
  - ì»¤ë„¥ì…˜ í’€: ë¶€íŠ¸ ê¸°ë³¸ì€ HikariCP 
  - ë¡œê¹… SLF4J & LogBack
  - í…ŒìŠ¤íŠ¸

## H2 ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì¹˜
ê°œë°œì´ë‚˜ í…ŒìŠ¤íŠ¸ ìš©ë„ë¡œ ê°€ë³ê³  í¸ë¦¬í•œ DB, ì›¹ í™”ë©´ ì œê³µ
- https://www.h2database.com
- ë‹¤ìš´ë¡œë“œ ë° ì„¤ì¹˜
- h2 ë°ì´í„°ë² ì´ìŠ¤ ë²„ì „ì€ ìŠ¤í”„ë§ ë¶€íŠ¸ ë²„ì „ì— ë§ì¶˜ë‹¤.

- ê¶Œí•œ ì£¼ê¸°: `chmod 755 h2.sh`
- ë°ì´í„°ë² ì´ìŠ¤ íŒŒì¼ ìƒì„± ë°©ë²•
  - `jdbc:h2:~/datajpa` (ìµœì†Œ í•œë²ˆ)
  - `~/datajpa.mv.db` íŒŒì¼ ìƒì„± í™•ì¸
  - ì´í›„ ë¶€í„°ëŠ” `jdbc:h2:tcp://localhost/~/datajpa` ì´ë ‡ê²Œ ì ‘ì†
  
> ì°¸ê³ : H2 ë°ì´í„°ë² ì´ìŠ¤ì˜ MVCC ì˜µì…˜ì€ H2 1.4.198 ë²„ì „ë¶€í„° ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìš© ë²„ì „ì´ 1.4.199ì´ ë¯€ë¡œ ì˜µì…˜ ì—†ì´ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

## ìŠ¤í”„ë§ ë°ì´í„° JPAì™€ DB ì„¤ì •, ë™ì‘í™•ì¸
`application.yml`
```yaml
spring:
  datasource:
    url: jdbc:h2:tcp://localhost/~/datajpa
    username: sa
    password:
    driver-class-name: org.h2.Driver

  jpa:
    hibernate:
      ddl-auto: create
    properties:
      hibernate:
        #show_sql: true
        format_sql: true

logging.level:
  org.hibernate.SQL: debug
  #org.hibernate.type: trace
```
- spring.jpa.hibernate.ddl-auto: create
  - ì´ ì˜µì…˜ì€ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì‹œì ì— í…Œì´ë¸”ì„ drop í•˜ê³ , ë‹¤ì‹œ ìƒì„±í•œë‹¤.

> ì°¸ê³ : ëª¨ë“  ë¡œê·¸ ì¶œë ¥ì€ ê°€ê¸‰ì  ë¡œê±°ë¥¼ í†µí•´ ë‚¨ê²¨ì•¼ í•œë‹¤.<br>
> `show_sql` : ì˜µì…˜ì€ System.out ì— í•˜ì´ë²„ë„¤ì´íŠ¸ ì‹¤í–‰ SQLì„ ë‚¨ê¸´ë‹¤.<br>
> `org.hibernate.SQL` : ì˜µì…˜ì€ loggerë¥¼ í†µí•´ í•˜ì´ë²„ë„¤ì´íŠ¸ ì‹¤í–‰ SQLì„ ë‚¨ê¸´ë‹¤.

## ì‹¤ì œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•˜ê¸°
#### íšŒì› ì—”í‹°í‹°
```java
  @Entity
  @Getter @Setter
  public class Member {
  
        @Id 
        @GeneratedValue
        private Long id;
        private String username;
        ...
}
```
### JPAì™€ Spring Data JPA ë¹„êµ
#### íšŒì› JPA ë¦¬í¬ì§€í† ë¦¬
```java
@Repository
public class MemberJpaRepository {

    @PersistenceContext
    private EntityManager em; // jpa ì“°ê¸° ìœ„í•´

    public Member save(Member member) {
        em.persist(member);
        return member;
    }

    public Member find(Long id) {
        return em.find(Member.class, id);
    }
}
```
#### JPA ê¸°ë°˜ í…ŒìŠ¤íŠ¸
```java
@SpringBootTest
@Transactional
@Rollback(false)
public class MemberJpaRepositoryTest {
    @Autowired
    MemberJpaRepository memberJpaRepository;
    
    @Test
    public void testMember() {
        Member member = new Member("memberA");
        Member savedMember = memberJpaRepository.save(member);

        Member findMember = memberJpaRepository.find(savedMember.getId());

        assertThat(findMember.getId()).isEqualTo(member.getId());
        assertThat(findMember.getUsername()).isEqualTo(member.getUsername());
        assertThat(findMember).isEqualTo(member); //JPA ì—”í‹°í‹° ë™ì¼ì„± ë³´ì¥
    } 
}
```

<br>

#### ìŠ¤í”„ë§ ë°ì´í„° JPA ë¦¬í¬ì§€í† ë¦¬
```java
public interface MemberRepository extends JpaRepository<Member, Long> {
}
```
#### ìŠ¤í”„ë§ ë°ì´í„° JPA ê¸°ë°˜ í…ŒìŠ¤íŠ¸
```java
@SpringBootTest
@Transactional
@Rollback(false)
public class MemberRepositoryTest {

    @Autowired
    MemberRepository memberRepository;

    @Test
    public void testMember() {
        Member member = new Member("memberA");
        Member savedMember = memberRepository.save(member);

        Member findMember = memberRepository.findById(savedMember.getId()).get();

        assertThat(findMember.getId()).isEqualTo(member.getId());
        assertThat(findMember.getUsername()).isEqualTo(member.getUsername());
        assertThat(findMember).isEqualTo(member); //JPA ì—”í‹°í‹° ë™ì¼ì„± ë³´ì¥
    }
}
```
- Entity, Repository ë™ì‘ í™•ì¸ 
- jar ë¹Œë“œí•´ì„œ ë™ì‘ í™•ì¸

> ì°¸ê³ : ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ í†µí•´ ë³µì¡í•œ ì„¤ì •ì´ ë‹¤ ìë™í™” ë˜ì—ˆë‹¤.<br>
> persistence.xml ë„ ì—†ê³ , LocalContainerEntityManagerFactoryBean ë„ ì—†ë‹¤.<br>
> ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ í†µí•œ ì¶”ê°€ ì„¤ì •ì€ ìŠ¤í”„ë§ ë¶€íŠ¸ ë©”ë‰´ì–¼ì„ ì°¸ê³ í•˜ê³  ìŠ¤í”„ë§ ë¶€íŠ¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ìˆœìˆ˜ ìŠ¤í”„ë§ê³¼ JPA ì„¤ì • ë°©ë²•ì€ ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë° ì±…ì„ ì°¸ê³ í•˜ì.

<br>

### ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë¡œê·¸ ë‚¨ê¸°ê¸° - ìŠ¤í”„ë§ ë¶€íŠ¸ 3.0
ìŠ¤í”„ë§ ë¶€íŠ¸ 3.0 ì´ìƒì„ ì‚¬ìš©í•˜ë©´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë²„ì „ì„ 1.9.0 ì´ìƒì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.


